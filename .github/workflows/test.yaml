# GitHub Actions workflow file.
#
# For more information, visit
# https://docs.github.com/actions/learn-github-actions.

name: test

# Trigger workflow on push or pull request to the develop, main, and master
# branches.
on:
  pull_request:
    branches:
      - develop
      - main
      - master
  push:
    branches:
      - develop
      - main
      - master

jobs:
  # Node is currently broken for FreeBSD. For more information, visit
  # https://github.com/nodejs/node/issues/40467#issuecomment-946902776.
  test-freebsd:
    name: Test bootstrapping software for FreeBSD
    runs-on: macos-10.15
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2
      - name: Test installation, setup, and bootstrapping
        uses: vmactions/freebsd-vm@v0.1.5
        with:
          prepare: pkg install -y bash curl
          run: |
            sudo freebsd-update fetch
            sudo freebsd-update install
            curl -LSfs https://raw.githubusercontent.com/wolfgangwazzlestrauss/bootware/master/install.sh | bash
            bootware setup
            bootware bootstrap --dev --no-passwd --skip deskenv,starship
            node tests/integration/roles.spec.js --arch amd64 --skip python,starship freebsd

  test-linux:
    name: >-
      Test bootstrapping software for ${{ matrix.arch }} ${{ matrix.distro }}
    strategy:
      fail-fast: false
      # Arm64 tests are currently removed since they cannot complete within
      # GitHub's job limit of 6 hours.
      matrix:
        arch: ["amd64"]
        distro: [arch, debian, fedora, ubuntu]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Build Docker image
        uses: docker/build-push-action@v2
        with:
          build-args: |
            skip=${{ matrix.skip }}
            test=true
          context: .
          file: ./tests/integration/Dockerfile.${{ matrix.distro }}
          platforms: linux/${{ matrix.arch }}
          push: false
          tags: wolfgangwazzlestrauss/bootware:${{ matrix.distro }}-latest

  test-macos:
    name: Test bootstrapping software for MacOS
    runs-on: macos-11
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2
      - name: Install Bootware
        run: >
          curl -LSfs
          https://raw.githubusercontent.com/wolfgangwazzlestrauss/bootware/master/install.sh
          | bash
      # Brew installation causes ModuleNotFound ansible.plugins.filter errors.
      - name: >-
          Install Ansible with Python since Brew installation appears to be
          broken
        run: python3 -m pip install ansible
      - name: Install dependencies for Bootware
        run: bootware setup
      # Bats is already installed with NPM and causes a conflict.
      - name: Test bootstrapping
        run: bootware bootstrap --dev --no-passwd --skip bats,docker
      - name: Test installed binaries for roles
        run: |
          source ${HOME}/.bashrc
          node tests/integration/roles.spec.js --arch amd64 --skip docker macos

  test-windows:
    name: Test bootstrapping software for Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2
      - name: Get current branch
        id: branch
        uses: tj-actions/branch-names@v4
      - uses: Vampire/setup-wsl@v1
        with:
          distribution: Ubuntu-20.04
          set-as-default: "true"
      - name: Install Bootware
        run: |
          ./install.ps1
          Copy-Item "./bootware.ps1" -Destination "C:/Program Files/Bootware/bootware.ps1"
        shell: powershell
      # The GitHub Windows server does not seem to update its path correctly.
      # Appears to work on other Windows servers.
      - name: Install dependencies for Bootware
        run: |
          $Env:Path = "C:\Program Files\Bootware;$Env:Path"
          bootware setup --checkout ${{ steps.branch.outputs.current_branch }}
        shell: powershell
      - name: Log all firewall rules on Windows host
        run: Get-NetFirewallRule -All
        shell: powershell
      # IdentitiesOnly is required to avoid an infinite wait for user password
      # input if the private key is rejected.
      - name: Test SSH connection from WSL to Windows host
        run: >-
          wsl ssh -vvv -i '$HOME/.ssh/bootware' -o IdentitiesOnly=yes -o
          StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
          $Env:UserName@127.0.0.1 dir
        shell: powershell
      # Default configuration file causes UTF-8 codec on Windows GitHub CI
      # servers. Unable to repeat on any other Windows system.
      - name: Copy Bootware configuration file
        run: |
          $Env:Path = "C:\Program Files\Bootware;$Env:Path"
          bootware config --empty
          Copy-Item "./tests/data/config.yaml" -Destination "$HOME/.bootware/config.yaml"
        shell: powershell
      # TODO: Remove build from skip tags when visualstudio2019buildtools
      # becomes reliable again.
      - name: Test bootstrapping
        run: |
          $Env:Path = "C:\Program Files\Bootware;$Env:Path"
          bootware bootstrap --no-setup --skip build,defterm
        shell: powershell
      # The GitHub Windows server does not seem to update its path correctly.
      # Appears to work on other Windows servers.
      - name: Test installed binaries for roles
        run: |
          $Env:Path = "$HOME\scoop\shims;$Env:LocalAppData\Programs\mongosh;$Env:Path"
          node tests/integration/roles.spec.js --arch amd64 windows
