# GitHub Actions workflow file.
#
# For more information, visit
# https://docs.github.com/actions/learn-github-actions.

name: build

on:
  push:
    branches:
      - develop
      - feature/*
      - master

jobs:
  lint:
    name: Check code with formatter and linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2
      - name: Install Node
        uses: actions/setup-node@v1
        with:
          node-version: 14
      - name: Install Node dependencies
        run: npm install
      - name: Check format of configuration files
        run: npm run prettier:test
      - name: Install Shfmt
        run: >-
          sudo curl -LSfs
          https://github.com/mvdan/sh/releases/download/v3.2.4/shfmt_v3.2.4_linux_amd64
          -o /usr/local/bin/shfmt
      - name: Check format of shell scripts
        run: |
          shfmt -d install.sh
          shfmt -d bootware.sh
          shfmt -d roles/
      - name: Run ShellCheck on shell scripts
        uses: ludeeus/action-shellcheck@master
        with:
          ignore: node_modules

  build:
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
    name: Build Docker image of Bootware installer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Build Docker image
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile
          outputs: type=docker,dest=/tmp/bootware.tar
          tags: wolfgangwazzlestrauss/bootware:latest
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: bootware
          path: /tmp/bootware.tar

  test-bash:
    name: Run unit tests for Bash scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2
      - name: Install Node
        uses: actions/setup-node@v1
        with:
          node-version: 14
      - name: Install Bats dependencies
        run: npm install
      - name: Run Bash unit tests with Bats
        run: npm run bats:test

  test-macos:
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
    name: Test bootstrapping software for MacOS
    runs-on: macos-latest
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2
      - name: Install Bootware
        run: >
          curl -LSfs
          https://raw.githubusercontent.com/wolfgangwazzlestrauss/bootware/master/install.sh
          | bash
      - name: Create Bootware configuration file
        run: bootware config --empty
      # Brew installation causes ModuleNotFound ansible.plugins.filter errors.
      - name: Install Ansible since Brew installation appears to be broken
        run: python3 -m pip install ansible
      - name: Install dependencies for Bootware
        run: bootware setup
      - name: Test bootstrapping
        run: bootware bootstrap --dev --no-passwd --skip docker,

  test-linux:
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
    name: Test bootstrapping software for ${{ matrix.distro }}
    strategy:
      fail-fast: false
      matrix:
        distro: [arch, debian, fedora, ubuntu]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Build Docker image
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./tests/integration/Dockerfile.${{ matrix.distro }}
          tags: wolfgangwazzlestrauss/bootware:${{ matrix.distro }}-latest
          push: false

  test-package:
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
    name: Test building a ${{ matrix.format }} package
    strategy:
      fail-fast: false
      matrix:
        format: [deb]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Build Docker image
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./tests/integration/Dockerfile.${{ matrix.format }}
          tags: bootware:${{ matrix.format }}
          push: false

  test-powershell:
    name: Run unit tests for PowerShell scripts
    runs-on: windows-latest
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2
      - name: Install Pester
        run: Install-Module Pester -Force
        shell: pwsh
      - name: Run PowerShell unit tests with Pester
        run: Invoke-Pester -Output Detailed ./tests/unit/
        shell: pwsh

  test-windows:
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
    name: Test bootstrapping software for Windows
    needs: build
    runs-on: windows-latest
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v2
      - name: Install Bootware
        run: >
          Invoke-WebRequest -UseBasicParsing -Uri
          https://raw.githubusercontent.com/wolfgangwazzlestrauss/bootware/master/install.ps1
          | Invoke-Expression
        shell: powershell
      # The GitHub Windows server does not seem to update its path correctly.
      # Appears to work on other Windows servers.
      - name: Create Bootware configuration file
        run: "& 'C:/Program Files/Bootware/bootware.ps1' config --empty"
        shell: powershell
      - name: Install dependencies for Bootware
        run: >-
          "& 'C:/Program Files/Bootware/bootware.ps1' bootware setup --no-wsl"
        shell: powershell
