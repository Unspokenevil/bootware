- name: Get latest PowerShell Core version
  register: powershell_formula
  when: ansible_system == "Win32NT"
  win_uri:
    url: https://formulae.brew.sh/api/cask/powershell.json
    method: GET
    return_content: yes

- name: Install PowerShell Core for Windows
  when: ansible_system == "Win32NT"
  win_package:
    arguments:
      - /quiet
      - ADD_EXPLORER_CONTEXT_MENU_OPENPOWERSHELL=1
      - ENABLE_PSREMOTING=1
      - REGISTER_MANIFEST=1
    path: >-
      https://github.com/PowerShell/PowerShell/releases/download/v{{
      powershell_formula.json.version }}/PowerShell-{{
      powershell_formula.json.version }}-win-x64.msi

- name: Create PowerShell settings directories for Windows
  become: yes
  become_user: "{{ user_account }}"
  loop:
    - Documents/PowerShell
    - Documents/WindowsPowerShell
    - Documents/WindowsPowerShell/Modules
  when: ansible_system == "Win32NT"
  win_file:
    path: "{{ user_home_dir }}/{{ item }}"
    state: directory

- name: Copy PowerShell settings files for Windows
  become: yes
  become_user: "{{ user_account }}"
  loop:
    - Documents/PowerShell/Microsoft.PowerShell_profile.ps1
    - Documents/WindowsPowerShell/Microsoft.PowerShell_profile.ps1
  when: ansible_system == "Win32NT"
  win_copy:
    dest: "{{ user_home_dir }}/{{ item }}"
    force: yes
    src: profile.ps1

# Disabled since trusting PSGallery is an absurdly frustrating process on
# Windows 11.
# - name: Trust default PowerShell repository
#   community.windows.win_psrepository: name: PSGallery installation_policy:
#   trusted when: ansible_system == "Win32NT"

# - name: Install PowerShell modules
#   become: yes
#   become_user: "{{ user_account }}"
#   community.windows.win_psmodule:
#     name: "{{ item }}"
#     skip_publisher_check: yes
#     state: latest
#   loop: "{{ powershell_modules }}"
#   when: ansible_system == "Win32NT"
