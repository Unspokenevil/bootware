# Shell installer for Deno accidentally installs ARM64 version on FreeBSD.
- name: Install Deno for FreeBSD
  community.general.pkgng:
    name: deno
  when: ansible_system == "FreeBSD"

# Deno Linux ARM support is in progress. See
# https://github.com/denoland/deno/issues/1846. Deno requires glibc, which is
# not available on Alpine.
- name: Install Deno for Unix
  become: true
  become_user: "{{ user_account }}"
  shell:
    cmd: curl -LSfs https://deno.land/x/install/install.sh | sh
    warn: false
  when: >-
    ansible_system == "Darwin" or (ansible_system == "Linux" and ansible_pkg_mgr
    != "apk" and ansible_architecture == "x86_64")

- name: Generate Deno Fish completions for Unix
  become: true
  become_user: "{{ user_account }}"
  shell:
    cmd: |
      source {{ user_home_dir }}/.bashrc
      deno completions fish > {{ user_home_dir }}/.config/fish/completions/deno.fish
    executable: "{{ bash_executable }}"
  when: >-
    ansible_system in ["Darwin", "FreeBSD"] or (ansible_system == "Linux" and
    ansible_pkg_mgr != "apk" and ansible_architecture == "x86_64")

- name: Install Deno for Windows
  become: true
  become_user: "{{ user_account }}"
  community.windows.win_scoop:
    architecture: 64bit
    name: deno
  when: ansible_system == "Win32NT"

- name: Create Deno PowerShell completions directory for Windows
  become: true
  become_user: "{{ user_account }}"
  when: ansible_system == "Win32NT"
  win_file:
    path: >-
      {{ user_home_dir }}/Documents/WindowsPowerShell/Modules/DenoCompletion
    state: directory

- name: Generate Deno PowerShell completions module for Windows
  become: true
  become_user: "{{ user_account }}"
  when: ansible_system == "Win32NT"
  win_shell: >-
    deno completions powershell > {{ user_home_dir
    }}/Documents/WindowsPowerShell/Modules/DenoCompletion/DenoCompletion.psm1
