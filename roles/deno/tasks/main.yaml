---
# Shell installer for Deno accidentally installs ARM64 version on FreeBSD.
- name: Install Deno for FreeBSD
  become: true
  community.general.pkgng:
    name: deno
  when: ansible_system == "FreeBSD"

# Deno Linux ARM support is in progress. See
# https://github.com/denoland/deno/issues/1846. Deno requires glibc, which is
# not available on Alpine.
- name: Install Deno for Unix
  shell:
    cmd: curl -LSfs https://deno.land/x/install/install.sh | sh
    warn: false
  when: >-
    ansible_system == "Darwin" or (ansible_system == "Linux" and ansible_pkg_mgr
    != "apk" and ansible_architecture == "x86_64")

- name: Create Fish completions directory for Unix
  file:
    mode: "755"
    owner: "{{ ansible_user_id }}"
    path: "{{ ansible_env.HOME }}/.config/fish/completions"
    state: directory
  when: ansible_system != "Win32NT"

# TODO: Add Bash completions with deno completions bash >
# /usr/local/etc/bash_completion.d/deno.bash.
- name: Generate Deno Fish completions for Unix
  environment:
    PATH: "{{ ansible_env.HOME }}/.deno/bin:{{ ansible_env.PATH }}"
  shell: >-
    deno completions fish > {{ ansible_env.HOME
    }}/.config/fish/completions/deno.fish
  when: >-
    ansible_system in ["Darwin", "FreeBSD"] or (ansible_system == "Linux" and
    ansible_pkg_mgr != "apk" and ansible_architecture == "x86_64")

- name: Install Deno for Windows
  community.windows.win_scoop:
    architecture: 64bit
    name: deno
  when: ansible_system == "Win32NT"

- name: Create Deno PowerShell completions directory for Windows
  when: ansible_system == "Win32NT"
  win_file:
    path: >-
      {{ ansible_env.HOME }}/Documents/WindowsPowerShell/Modules/DenoCompletion
    state: directory

- name: Generate Deno PowerShell completions module for Windows
  when: ansible_system == "Win32NT"
  win_shell: >-
    deno completions powershell > {{ ansible_env.HOME
    }}/Documents/WindowsPowerShell/Modules/DenoCompletion/DenoCompletion.psm1
