---
- name: Update packages for Alpine distributions
  become: true
  community.general.apk:
    update_cache: true
    upgrade: true
  when: ansible_pkg_mgr == "apk"

- name: Update packages for Arch distributions
  become: true
  community.general.pacman:
    update_cache: true
    upgrade: true
  when: ansible_pkg_mgr == "pacman"

- name: Update packages for Debian distributions
  ansible.builtin.apt:
    autoremove: true
    update_cache: true
    upgrade: full
  become: true
  when: ansible_pkg_mgr == "apt"

- name: Update packages for Fedora distributions
  ansible.builtin.dnf:
    autoremove: true
    # Updating all packages causes an error since dnf would be removed.
    # name: "*"
    update_cache: true
  become: true
  when: ansible_pkg_mgr == "dnf"

- name: Update packages for MacOS
  community.general.homebrew:
    update_homebrew: true
    upgrade_all: true
  when: ansible_system == "Darwin"

- name: Install essential packages for Alpine distributions
  become: true
  community.general.apk:
    name: xz
  when: ansible_pkg_mgr == "apk"

- name: Install essential packages for Arch distributions
  become: true
  community.general.pacman:
    name:
      - libxcrypt-compat
      - openssh
      - pkgconf
      - which
  when: ansible_pkg_mgr == "pacman"

- name: Install essential packages for Debian distributions
  ansible.builtin.apt:
    name:
      - apt-file
      - apt-transport-https
      - gnupg2
      - lsb-release
      - openssh-client
      - pbuilder
      - ubuntu-dev-tools
  become: true
  when: ansible_pkg_mgr == "apt"

- name: Install essential packages for Fedora distributions
  ansible.builtin.dnf:
    name:
      - dnf-plugins-core
      - findutils
      - openssl-devel
      - perl-FindBin
      - procps
      - python
      - which
  become: true
  when: ansible_pkg_mgr == "dnf"

# Adding openssl to the package list causes Node to throw the error 'version
# OPENSSL_1_1_1e required by /usr/local/bin/node not found' in the CI tests.
- name: Install essential packages for FreeBSD
  become: true
  community.general.pkgng:
    name:
      - gnupg
      - gtar
      - htop
      - iftop
      - neofetch
      - sudo
      - unzip
      - zip
  when: ansible_system == "FreeBSD"

- name: Install essential packages for Linux
  ansible.builtin.package:
    name:
      - ca-certificates
      - flatpak
      - gnupg
      - htop
      - iftop
      - iotop
      - neofetch
      - openssl
      - sudo
      - tar
      - unzip
      - zip
    state: present
  become: true
  when: ansible_system == "Linux"

- name: Install essential packages for MacOS
  community.general.homebrew:
    name:
      - neofetch
      - openssh
      - unzip
      - zip
  when: ansible_system == "Darwin"

- name: Install essential packages for Suse distributions
  ansible.builtin.zypper:
    name: gzip
  become: true
  when: ansible_pkg_mgr == "zypper"

- name: Add essential Scoop buckets for Windows
  community.windows.win_scoop_bucket:
    name: "{{ item }}"
  environment:
    Path: "{{ ansible_env.HOME }}\\scoop\\shims\\scoop;{{ ansible_env.Path }}"
  loop:
    - extras
    - main
    - nerd-fonts
    - versions
  when: ansible_system == "Win32NT"

- name: Install essential packages for Windows
  community.windows.win_scoop:
    name:
      - 7zip
      - neofetch
      - openssl
      - scoop-completion
      - unzip
      - zip
  when: ansible_system == "Win32NT"
