---
- name: Install RVM dependencies for Debian distributions
  ansible.builtin.apt:
    name:
      - debianutils
      - procps
  become: true
  when: ansible_pkg_mgr == "apt"

- name: Install RVM dependencies for Fedora distributions
  ansible.builtin.dnf:
    name:
      - findutils
      - procps
      - which
  become: true
  when: ansible_pkg_mgr == "dnf"

- name: Install RVM dependencies for MacOS
  community.general.homebrew:
    name: gpg
  when: ansible_system == "Darwin"

- name: Install Ruby dependencies for Windows
  community.windows.win_scoop:
    name:
      - mingw-winlibs
      - msys2
  when: ansible_system == "Win32NT"

# RVM does not appear to be compatible with Busybox.
- name: Install Ruby for Alpine
  become: true
  community.general.apk:
    name:
      - ruby
      - ruby-dev
  when: ansible_pkg_mgr == "apk"

# RVM does not provide binaries for FreeBSD.
- name: Install Ruby for FreeBSD
  become: true
  community.general.pkgng:
    name:
      - ruby
      # - ruby-dev
      - ruby27-gems
  when: ansible_system == "FreeBSD"

- name: Install RVM GPG keys for Unix
  ansible.builtin.shell:
    cmd: |
      curl -LSfs https://rvm.io/mpapis.asc | gpg --import -
      curl -LSfs https://rvm.io/pkuczynski.asc | gpg --import -
    warn: false
  when: >-
    ansible_system not in ["FreeBSD", "Win32NT"] and ansible_pkg_mgr != "apk"

- name: Install Ruby Environment Manager for Unix
  ansible.builtin.shell:
    cmd: curl -LSfs https://get.rvm.io | bash -s stable
    warn: false
  when: >-
    ansible_system not in ["FreeBSD", "Win32NT"] and ansible_pkg_mgr != "apk"

- name: Install multiple Ruby versions for Unix
  ansible.builtin.shell:
    cmd: |
      source {{ ansible_env.HOME }}/.bashrc
      rvm install {{ item }}
    executable: "{{ bash_executable }}"
  loop: "{{ ruby_versions }}"
  when: >-
    ansible_system not in ["FreeBSD", "Win32NT"] and ansible_pkg_mgr != "apk"

- name: Install multiple Ruby versions for Windows
  community.windows.win_scoop:
    name: >-
      ruby{{ item | replace('ruby-','') | replace('.','') | replace('30','') }}
  loop: "{{ ruby_versions }}"
  when: ansible_system == "Win32NT"

# TODO: Switch to Ansible Gem module.
- name: Install or update Ruby CLI applications for Unix
  ansible.builtin.shell:
    cmd: |
      source {{ ansible_env.HOME }}/.bashrc
      gem install --user-install {{ item }}
    executable: "{{ bash_executable }}"
  loop: "{{ ruby_applications }}"
  when: ansible_system != "Win32NT"

- name: Install or update Ruby CLI applications for Windows
  ansible.builtin.win_command: gem install --user-install {{ item }}
  loop: "{{ ruby_applications }}"
  when: ansible_system == "Win32NT"

- name: Download RVM Fish for Unix
  ansible.builtin.get_url:
    dest: "{{ ansible_env.HOME }}/.config/fish/functions/rvm.fish"
    mode: "644"
    owner: "{{ ansible_user_id }}"
    url: https://raw.github.com/lunks/fish-nuggets/master/functions/rvm.fish
  when: >-
    ansible_system not in ["FreeBSD", "Win32NT"] and ansible_pkg_mgr != "apk"
