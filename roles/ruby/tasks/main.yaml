- name: Install RVM dependencies for Debian distributions
  apt:
    name:
      - debianutils
      - procps
  become: yes
  when: ansible_pkg_mgr == "apt"

- name: Install RVM dependencies for Fedora distributions
  become: yes
  dnf:
    name:
      - findutils
      - procps
      - which
  when: ansible_pkg_mgr == "dnf"

- name: Install RVM dependencies for MacOS
  become_user: "{{ user_account }}"
  community.general.homebrew:
    name: gpg
  when: ansible_system == "Darwin"

# TODO: Figure out how to make GPG not return a user interaction error code.
- name: Install RVM GPG keys for Unix
  become_user: "{{ user_account }}"
  failed_when: rvm_gpg.rc not in [0, 2]
  register: rvm_gpg
  shell:
    cmd: >-
      gpg --always-trust --yes --keyserver keys.openpgp.org --recv-keys
      409B6B1796C275462A1703113804BB82D39DC0E3
      7D2BAF1CF37B13E2069D6956105BD0E739499BDBÃŸ
  when: ansible_system in ["Darwin", "Linux"]

- name: Install Ruby Environment Manager for Unix
  become_user: "{{ user_account }}"
  shell:
    cmd: curl -LSfs https://get.rvm.io | bash -s stable
    warn: no
  when: ansible_system in ["Darwin", "Linux"]

- name: Install multiple Ruby versions for Unix
  become_user: "{{ user_account }}"
  loop: "{{ ruby_versions }}"
  shell:
    cmd: |
      source {{ user_home_dir }}/.bashrc
      rvm install {{ item }}
    executable: /bin/bash
  when: ansible_system in ["Darwin", "Linux"]

- name: Install multiple Ruby versions for Windows
  become_user: "{{ user_account }}"
  community.windows.win_scoop:
    architecture: 64bit
    name:
      ruby{{ item | replace('ruby-','') | replace('.','') | replace('30','') }}
  loop: "{{ ruby_versions }}"
  when: ansible_system == "Win32NT"

- name: Install or update Ruby CLI applications for Unix
  become_user: "{{ user_account }}"
  loop: "{{ ruby_applications }}"
  shell:
    cmd: |
      source {{ user_home_dir }}/.bashrc
      gem install {{ item }}
    executable: /bin/bash
  when: ansible_system in ["Darwin", "Linux"]

- name: Install or update Ruby CLI applications for Windows
  become_user: "{{ user_account }}"
  loop: "{{ ruby_applications }}"
  win_shell: gem install {{ item }}
  when: ansible_system == "Win32NT"

- name: Download RVM Fish for Unix
  become_user: "{{ user_account }}"
  get_url:
    dest: "{{ user_home_dir }}/.config/fish/functions/rvm.fish"
    mode: 0644
    url: https://raw.github.com/lunks/fish-nuggets/master/functions/rvm.fish
  when: ansible_system in ["Darwin", "Linux"]
