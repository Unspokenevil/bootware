- name: Install Python Apt packages for Debian distributions
  apt:
    name:
      - python3
      - python3-dev
      - python3-pip
      - python3-venv
    state: latest
    update_cache: yes
  become: yes
  when: ansible_os_family in ["Debian", "Pop!_OS", "Ubuntu"]

- name: Install Pyenv dependencies for Debian distributions
  apt:
    name:
      - build-essential
      - curl
      - git
      - libbluetooth-dev
      - libbz2-dev
      - libffi-dev
      - liblzma-dev
      - libncurses5-dev
      - libncursesw5-dev
      - libreadline-dev
      - libsqlite3-dev
      - libssl-dev
      - llvm
      - python3-openssl
      - tk-dev
      - uuid-dev
      - wget
      - xz-utils
      - zlib1g-dev
    state: latest
    update_cache: yes
  become: yes
  when: ansible_os_family in ["Debian", "Pop!_OS", "Ubuntu"]

- name: Install ONNX dependencies for Debian distributions
  apt:
    name:
      - cmake
      - libprotoc-dev
      - protobuf-compiler
    state: latest
    update_cache: yes
  become: yes
  when: ansible_os_family in ["Debian", "Pop!_OS", "Ubuntu"]

- name: Make system Python interpreter discoverable by Pyenv for Linux
  become: yes
  file:
    src: /usr/bin/python3
    dest: /usr/bin/python
    mode: 0755
    state: link
  when: ansible_system == "Linux"

- name: Install system Python packages and Pipx for Linux
  become: yes
  shell:
    cmd: python3 -m pip install --upgrade pip pipx setuptools wheel
  when: ansible_system == "Linux"

- name: Install Pipx command line applications
  become: yes
  loop: "{{ python_applications}}"
  shell:
    cmd: pipx install {{ item }}

- name: Install Pyenv for Unix
  become_user: "{{ user_account }}"
  shell:
    cmd: curl -Sfs https://pyenv.run | bash
    creates: "{{ user_home_dir}}/.pyenv/bin/pyenv"
    warn: no
  when: ansible_system in ["Darwin", "Linux"]

- name: Get latest patch release for each Python minor version
  become_user: "{{ user_account }}"
  loop: "{{ python_versions }}"
  shell:
    cmd: >-
      pyenv install --list | grep -E "^\\s*{{ item }}.[0-9]+\\s*$" | tail -1 |
      xargs
  register: pyenv_releases
  when: ansible_system in ["Darwin", "Linux"]

- name: Extract Python versions from Pyenv outputs
  set_fact:
    python_releases: "{{ pyenv_releases.results | map(attribute='stdout') | list }}"

- name: Install multiple Python versions for Unix
  become_user: "{{ user_account }}"
  loop: "{{ python_releases }}"
  shell:
    cmd: pyenv install -s {{ item }}
  when: ansible_system in ["Darwin", "Linux"]

- name: Set Python global versions
  become_user: "{{ user_account }}"
  shell:
    cmd: "pyenv global {{ python_releases | reverse | join(' ') }}"
  when: ansible_system in ["Darwin", "Linux"]

- name: Create Jupyter settings directory
  become_user: "{{ user_account }}"
  file:
    path: "{{ user_home_dir}}/.jupyter"
    state: directory

- name: Copy Jupyter notebook settings file
  become_user: "{{ user_account }}"
  copy:
    dest: "{{ user_home_dir}}/.jupyter/jupyter_notebook_config.py"
    force: yes
    mode: 0755
    src: jupyter_notebook_config.py
