---
- name: Install VSCode for Alpine
  become: true
  community.general.apk:
    name: vscodium
    repository: http://dl-cdn.alpinelinux.org/alpine/edge/testing
    state: latest
    update_cache: true
  tags:
    - install
  when: ansible_pkg_mgr == "apk"

- name: Install VSCode for Arch
  ansible.builtin.command:
    cmd: yay --noconfirm --refresh --sync vscodium-bin
  become: true
  become_user: "{{ user_id }}"
  changed_when: "'installing vscodium' in vscode_arch_install"
  register: vscode_arch_install
  tags:
    - install
  when: ansible_pkg_mgr == "pacman"

- name: Create VSCode temporary directory for Debian
  ansible.builtin.tempfile:
    state: directory
  register: vscode_temp
  tags:
    - install
  when: ansible_pkg_mgr == "apt"

- name: Set VSCode temporary directory permissions for Debian
  ansible.builtin.file:
    mode: "755"
    path: "{{ vscode_temp.path }}"
    state: directory
  tags:
    - install
  when: ansible_pkg_mgr == "apt"

- name: Download VSCode GPG key for Debian
  ansible.builtin.get_url:
    dest: "{{ vscode_temp.path }}/vscodium-archive-keyring.gpg"
    mode: "640"
    url: https://gitlab.com/paulcarroty/vscodium-deb-rpm-repo/raw/master/pub.gpg
  become: true
  tags:
    - install
  when: ansible_pkg_mgr == "apt"

- name: Add VSCode GPG key for Debian
  ansible.builtin.command:
    cmd: >-
      gpg --batch --dearmor --yes --output
      /usr/share/keyrings/vscodium-archive-keyring.gpg {{ vscode_temp.path
      }}/vscodium-archive-keyring.gpg
    creates: /usr/share/keyrings/vscodium-archive-keyring.gpg
  become: true
  tags:
    - install
  when: ansible_pkg_mgr == "apt"

- name: Add VSCode repository for Debian
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch=amd64,arm64
      signed-by=/usr/share/keyrings/vscodium-archive-keyring.gpg]
      https://download.vscodium.com/debs vscodium main
    state: present
    filename: vscodium
  become: true
  ignore_errors: true
  register: vscode_debian
  tags:
    - install
  when: ansible_pkg_mgr == "apt"

- name: Install VSCode for Debian
  ansible.builtin.apt:
    name: codium
  become: true
  tags:
    - install
  when: ansible_pkg_mgr == "apt"

- name: Add VSCode GPG key for Fedora
  ansible.builtin.rpm_key:
    key: https://gitlab.com/paulcarroty/vscodium-deb-rpm-repo/-/raw/master/pub.gpg
  become: true
  tags:
    - install
  when: ansible_pkg_mgr in ["dnf", "dnf5", "zypper"]

- name: Add VSCode repository for Fedora
  ansible.builtin.copy:
    content: |
      [gitlab.com_paulcarroty_vscodium_repo]
      baseurl=https://download.vscodium.com/rpms/
      enabled=1
      gpgcheck=1
      gpgkey=https://gitlab.com/paulcarroty/vscodium-deb-rpm-repo/-/raw/master/pub.gpg
      metadata_expire=1h
      name=download.vscodium.com
      repo_gpgcheck=1
    dest: /etc/yum.repos.d/vscodium.repo
    force: true
    mode: "640"
  become: true
  tags:
    - install
  when: ansible_pkg_mgr in ["dnf", "dnf5", "zypper"]

- name: Install VSCode for Fedora
  ansible.builtin.dnf:
    name: codium
  become: true
  tags:
    - install
  when: ansible_pkg_mgr in ["dnf", "dnf5", "zypper"]

- name: Install VSCode for MacOS
  community.general.homebrew_cask:
    accept_external_apps: true
    name: vscodium
    state: present
  tags:
    - install
  when: ansible_system == "Darwin"

- name: Install VSCode for Windows
  chocolatey.chocolatey.win_chocolatey:
    choco_args:
      - --params
      - "/NoDesktopIcon"
    name: vscodium
  tags:
    - install
  when: ansible_system == "Win32NT"

- name: Install VSCode extensions for Unix
  ansible.builtin.command:
    cmd: codium --install-extension {{ item }}
  become: true
  become_user: "{{ user_id }}"
  changed_when: "'successfully installed' in vscode_extension_install"
  environment:
    PATH: >-
      /opt/homebrew/bin:/usr/local/bin:/usr/share/codium/bin:{{ ansible_env.PATH
      }}
  loop: "{{ vscode_extensions }}"
  register: vscode_extension_install
  tags:
    - plugin
  when: ansible_system in ["Darwin", "Linux"] and ansible_pkg_mgr != "apk"

- name: Install VSCode extensions for Windows
  ansible.windows.win_shell: codium --install-extension {{ item }}
  changed_when: "'successfully installed' in vscode_extension_install"
  environment:
    Path: C:\Program Files\VSCodium\bin;{{ ansible_env.Path }}
  loop: "{{ vscode_extensions }}"
  register: vscode_extension_install
  tags:
    - plugin
  when: ansible_system == "Win32NT"

- name: Create VSCode user directory for MacOS
  ansible.builtin.file:
    group: "{{ group_id }}"
    mode: "755"
    owner: "{{ user_id }}"
    path: "{{ user_home }}/Library/Application Support/VSCodium/User"
    state: directory
  become: true
  tags:
    - config
  when: ansible_system == "Darwin"

- name: Copy VSCode keybindings file for MacOS
  ansible.builtin.template:
    dest: >-
      {{ user_home }}/Library/Application Support/VSCodium/User/keybindings.json
    force: true
    group: "{{ group_id }}"
    mode: "644"
    owner: "{{ user_id }}"
    src: keybindings.json.j2
  become: true
  tags:
    - config
  when: ansible_system == "Darwin"

- name: Copy VSCode settings file for MacOS
  ansible.builtin.template:
    dest: >-
      {{ user_home }}/Library/Application Support/VSCodium/User/settings.json
    force: true
    group: "{{ group_id }}"
    mode: "644"
    owner: "{{ user_id }}"
    src: settings.json.j2
  become: true
  tags:
    - config
  when: ansible_system == "Darwin"

- name: Create VSCode user directory for Linux
  ansible.builtin.file:
    group: "{{ group_id }}"
    mode: "755"
    owner: "{{ user_id }}"
    path: "{{ user_home }}/.config/VSCodium/User"
    state: directory
  become: true
  tags:
    - config
  when: ansible_system == "Linux" and ansible_pkg_mgr != "apk"

- name: Copy VSCode keybindings file for Linux
  ansible.builtin.template:
    dest: "{{ user_home }}/.config/VSCodium/User/keybindings.json"
    force: true
    group: "{{ group_id }}"
    mode: "644"
    owner: "{{ user_id }}"
    src: keybindings.json.j2
  become: true
  tags:
    - config
  when: ansible_system == "Linux" and ansible_pkg_mgr != "apk"

- name: Copy VSCode settings file for Linux
  ansible.builtin.template:
    dest: "{{ user_home }}/.config/VSCodium/User/settings.json"
    force: true
    group: "{{ group_id }}"
    mode: "644"
    owner: "{{ user_id }}"
    src: settings.json.j2
  become: true
  tags:
    - config
  when: ansible_system == "Linux" and ansible_pkg_mgr != "apk"

- name: Create VSCode user directory for Windows
  ansible.windows.win_file:
    path: "{{ user_home }}\\AppData\\Roaming\\VSCodium\\User"
    state: directory
  tags:
    - config
  when: ansible_system == "Win32NT"

- name: Copy VSCode keybindings file for Windows
  ansible.windows.win_template:
    dest: "{{ user_home }}\\AppData\\Roaming\\VSCodium\\User\\keybindings.json"
    force: true
    src: keybindings.json.j2
  tags:
    - config
  when: ansible_system == "Win32NT"

- name: Copy VSCode settings file for Windows
  ansible.windows.win_template:
    dest: "{{ user_home }}\\AppData\\Roaming\\VSCodium\\User\\settings.json"
    force: true
    owner: "{{ user_id }}"
    src: settings.json.j2
  tags:
    - config
  when: ansible_system == "Win32NT"

- name: Apply customizations to VSCode
  ansible.builtin.import_tasks: customize.yaml
  tags:
    - config
  when: >-
    vscode_install_customizations and ansible_system in ["Darwin", "Linux",
    "Win32NT"] and ansible_pkg_mgr != "apk"

- name: Set owner of VSCode files for Windows
  ansible.windows.win_owner:
    path: "{{ user_home }}\\{{ item }}"
    recurse: true
    user: "{{ user_id }}"
  loop:
    - .vscode-oss
    - AppData\Roaming\VSCodium
  tags:
    - config
  when: ansible_system == "Win32NT"
