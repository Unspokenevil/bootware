---
- name: Check if Forge extension is installed for GNOME desktops
  ansible.builtin.command: gnome-extensions show forge@jmmaranan.com
  become: true
  become_user: "{{ user_id }}"
  changed_when: false
  ignore_errors: true
  register: winman_forge_check

- name: Find GNOME version for GNOME desktops
  ansible.builtin.shell:
    cmd: gnome-shell --version | cut -d' ' -f3
  become: true
  become_user: "{{ user_id }}"
  changed_when: false
  register: winman_forge_gnome_version
  when: winman_forge_check is failed

- name: Get latest Forge extension version for GNOME desktops
  ansible.builtin.uri:
    method: GET
    return_content: true
    url: >-
      https://extensions.gnome.org/extension-info/?uuid=forge@jmmaranan.com&shell_version={{
      winman_forge_gnome_version.stdout }}
  register: winman_forge_release
  when: winman_forge_check is failed

- name: Download Forge extension for GNOME desktops
  ansible.builtin.get_url:
    dest: /tmp/forge_extension.zip
    mode: "600"
    url:
      https://extensions.gnome.org{{ winman_forge_release.json.download_url }}
  when: winman_forge_check is failed

- name: Install Forge extension for GNOME desktops
  ansible.builtin.command: >-
    gnome-extensions install /tmp/forge_extension.zip
  become: true
  become_user: "{{ user_id }}"
  # Command does not provide stdout information to determine a change.
  changed_when: true
  when: winman_forge_check is failed

- name: Enable Forge extension for GNOME desktops
  ansible.builtin.command: gnome-extensions enable forge@jmmaranan.com
  become: true
  become_user: "{{ user_id }}"
  # Command does not provide stdout information to determine a change.
  changed_when: true

- name: Change Forge settings for GNOME desktops
  ansible.builtin.script: forge.sh
  become: true
  become_user: "{{ user_id }}"
